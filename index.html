<!DOCTYPE html>
<html>
    <head>
        <title>Figma to ESPHome converter</title>
        <link rel="stylesheet" href="./css/style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/default.min.css">
    </head>
    <body>
        <div id="settings-form">
            <h2 class="header">Figma to ESPHome converter</h2>
            <h4>Generates YML and C++ code for an ESPHome display from a Figma document</h4>
            <div>
                <label for="figma_url">Figma Api URL<span class="info">URL of the Figma API</span></label></br>
                <input type="text" id="figma_url" placeholder="Figma Files API URL" value="https://api.figma.com/v1/files"></input>

                <label for="figma_api_token">Figma Api Token<span class="info">Token for the Figma Api: <a href="https://www.figma.com/developers/api#access-tokens" target="_blank">info</a></span></label></br>
                <input type="text" id="figma_api_token" placeholder="Token for the Figma Files API" value=""></input>

                <label for="figma_file_key">Figma file key<span class="info">The unique identifier of the Figma file</span></label></br>
                <input type="text" id="figma_file_key" placeholder="Key of your Figma file" value=""></input>

                <label for="page_name">Page name<span class="info">Name of the page, the design is on</span></label></br>
                <input type="text" id="page_name" placeholder="Name of the page in the Figma file, e.g. 'Page 1'" value=""></input>

                <label for="frame_name">Frame name<span class="info">The frame that contains the design</span></label></br>
                <input type="text" id="frame_name" placeholder="Name of the frame that contains the UI design, e.g. 'Frane 1'" value=""></input>

                <button id="generateBtn" type="submit">Generate</button>
            </div>
        </div>
    
        <div id="results" class="hidden">
            <span class="title">YML</span>
            <span class="result_info">Copy these lines into your main ESPHome YML file, or save them in a new .yml file and include that in your main YML</span>
            <pre>
                <code id="ymlBlob" class="language-yml"></code>
                <div class="copy_result">
                    <button type="button" title="Copy result" id="copy_to_clipboard_ymlBlob" class="copy_result_button" target-filed="ymlBlob">
                        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5.00005C7.01165 5.00082 6.49359 5.01338 6.09202 5.21799C5.71569 5.40973 5.40973 5.71569 5.21799 6.09202C5 6.51984 5 7.07989 5 8.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.07989 21 8.2 21H15.8C16.9201 21 17.4802 21 17.908 20.782C18.2843 20.5903 18.5903 20.2843 18.782 19.908C19 19.4802 19 18.9201 19 17.8V8.2C19 7.07989 19 6.51984 18.782 6.09202C18.5903 5.71569 18.2843 5.40973 17.908 5.21799C17.5064 5.01338 16.9884 5.00082 16 5.00005M8 5.00005V7H16V5.00005M8 5.00005V4.70711C8 4.25435 8.17986 3.82014 8.5 3.5C8.82014 3.17986 9.25435 3 9.70711 3H14.2929C14.7456 3 15.1799 3.17986 15.5 3.5C15.8201 3.82014 16 4.25435 16 4.70711V5.00005M12 15H9M15 11H9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </pre>
    
            <span class="title">C++ functions</span>
            <span class="result_info">It is best to create a new .h file for these functions, then `#include "./thatfile.h"` in your main ESPHome display lambda code section</span>
            <pre>
                <code id="functionBlob" class="language-cpp"></code>
                <div class="copy_result">
                    <button type="button" title="Copy result" id="copy_to_clipboard_functionBlob" class="copy_result_button" target-filed="functionBlob">
                        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5.00005C7.01165 5.00082 6.49359 5.01338 6.09202 5.21799C5.71569 5.40973 5.40973 5.71569 5.21799 6.09202C5 6.51984 5 7.07989 5 8.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.07989 21 8.2 21H15.8C16.9201 21 17.4802 21 17.908 20.782C18.2843 20.5903 18.5903 20.2843 18.782 19.908C19 19.4802 19 18.9201 19 17.8V8.2C19 7.07989 19 6.51984 18.782 6.09202C18.5903 5.71569 18.2843 5.40973 17.908 5.21799C17.5064 5.01338 16.9884 5.00082 16 5.00005M8 5.00005V7H16V5.00005M8 5.00005V4.70711C8 4.25435 8.17986 3.82014 8.5 3.5C8.82014 3.17986 9.25435 3 9.70711 3H14.2929C14.7456 3 15.1799 3.17986 15.5 3.5C15.8201 3.82014 16 4.25435 16 4.70711V5.00005M12 15H9M15 11H9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </pre>
    
            <span class="title">C++ code</span>
            <span class="result_info">Copy these lines into your main ESPHome display lambda code section. Make sure to assign a value to all of the variables!</span>
            <pre>
                <code id="codeBlob" class="language-cpp"></code>
                <div class="copy_result">
                    <button type="button" title="Copy result" id="copy_to_clipboard_codeBlob" class="copy_result_button" target-filed="codeBlob">
                        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5.00005C7.01165 5.00082 6.49359 5.01338 6.09202 5.21799C5.71569 5.40973 5.40973 5.71569 5.21799 6.09202C5 6.51984 5 7.07989 5 8.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.07989 21 8.2 21H15.8C16.9201 21 17.4802 21 17.908 20.782C18.2843 20.5903 18.5903 20.2843 18.782 19.908C19 19.4802 19 18.9201 19 17.8V8.2C19 7.07989 19 6.51984 18.782 6.09202C18.5903 5.71569 18.2843 5.40973 17.908 5.21799C17.5064 5.01338 16.9884 5.00082 16 5.00005M8 5.00005V7H16V5.00005M8 5.00005V4.70711C8 4.25435 8.17986 3.82014 8.5 3.5C8.82014 3.17986 9.25435 3 9.70711 3H14.2929C14.7456 3 15.1799 3.17986 15.5 3.5C15.8201 3.82014 16 4.25435 16 4.70711V5.00005M12 15H9M15 11H9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </pre>
    
            <span class="title">Files</span>
            <span class="result_info">These are the image files used in the Figma design. Download all of them into the forlder specified in the YML section!</span>
            <div class="download">
                <ul id="download_items">
                </ul>
            </div>
        </div>

        <div id="footer">
            <div id="copyright">
                &copy; 2024 - <a href="https://github.com/notisrac" target="_blank">noti</a> | <img src="./images/github-mark.svg"> <a href="https://github.com/notisrac/FigmaToESPHome" target="_blank">source</a>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
        <script type="module">
            import { CodeGenerator } from "./scripts/codegen.js";

            function enableControls() {
                toggleElements([generateBtn, textFigmaUrl, textFigmaApiToken, textFigmaFileKey, textPageName, textFrameName], false);
                generateBtn.textContent = 'Generate';
            }

            function disableControls() {
                toggleElements([generateBtn, textFigmaUrl, textFigmaApiToken, textFigmaFileKey, textPageName, textFrameName], true);
            }

            function showResults() {
                if (results.classList.contains('hidden')) {
                    results.classList.remove('hidden');
                }
            }

            function hideResults() {
                if (!results.classList.contains('hidden')) {
                    results.classList.add('hidden');
                }
            }

            function toggleElements(elements, disable) {
                for (const element of elements) {
                    if (disable) {
                        element.classList.add('disabled');
                    } else {
                        element.classList.remove('disabled');
                    }
                }
            }

            function valueFromQueryParam(urlParams, elements) {
                for (const element of elements) {
                    if (urlParams.has(element.id)) {
                        element.value = urlParams.get(element.id);
                    }
                }
            }

            function reset() {
                // clear the generated codes and unset the highlighted attribute
                ymlBlob.textContent = '';
                if (ymlBlob.attributes.getNamedItem('data-highlighted')) {
                    ymlBlob.attributes.removeNamedItem('data-highlighted');
                }
                functionBlob.textContent = '';
                if (functionBlob.attributes.getNamedItem('data-highlighted')) {
                    functionBlob.attributes.removeNamedItem('data-highlighted');
                }
                codeBlob.textContent = '';
                if (codeBlob.attributes.getNamedItem('data-highlighted')) {
                    codeBlob.attributes.removeNamedItem('data-highlighted');
                }
                // remove all the children from the download items list
                while (downloadItems.firstChild) {
                    downloadItems.removeChild(downloadItems.firstChild);
                }
                // hide the results
                hideResults();
                // revoke all the image urls
                for (const url of urlList) {
                    URL.revokeObjectURL(url);
                }
            }


            const textFigmaUrl = document.getElementById('figma_url');
            const textFigmaApiToken = document.getElementById('figma_api_token');
            const textFigmaFileKey = document.getElementById('figma_file_key');
            const textPageName = document.getElementById('page_name');
            const textFrameName = document.getElementById('frame_name');

            const urlParams = new URLSearchParams(window.location.search);
            valueFromQueryParam(urlParams, [textFigmaUrl, textFigmaApiToken, textFigmaFileKey, textPageName, textFrameName]);

            const ymlBlob = document.getElementById('ymlBlob');
            const functionBlob = document.getElementById('functionBlob');
            const codeBlob = document.getElementById('codeBlob');
            const downloadedFiles = document.getElementById('downloadedFiles');
            const results = document.getElementById('results');

            const generateBtn = document.getElementById('generateBtn');

            const downloadItems = document.getElementById('download_items');

            const copyResultButtons = document.getElementsByClassName('copy_result_button');
            for (const btn of copyResultButtons) {
                btn.addEventListener('click', (e) => {
                    const targetFiledName = e.currentTarget.attributes["target-filed"].value;
                    // Get the text field
                    var copyText = document.getElementById(targetFiledName);
                    // Copy the text inside the text field
                    navigator.clipboard.writeText(copyText.innerText);
                });
            }

            const urlList = new Array();

            enableControls();
            hideResults();

            generateBtn.addEventListener('click', () => {
                reset();
                disableControls();
                generateBtn.textContent = 'Generating...';

                const gen = new CodeGenerator(textFigmaUrl.value, textFigmaApiToken.value, textFigmaFileKey.value, textPageName.value, textFrameName.value);
                console.log('Generating code...');
                gen.generate().then((generatedData) => {
                    ymlBlob.textContent = generatedData['ymlBlob'];
                    functionBlob.textContent = generatedData['functionBlob'];
                    codeBlob.textContent = generatedData['codeBlob'];
                    let filesInfo = [];
                    for (const imageFile of generatedData['downloadedFiles']) {
                        // create the url for the image file
                        let blob = new Blob( [ imageFile.dataBuffer ], { type: imageFile.mimeType } );
                        var imageUrl = URL.createObjectURL( blob );
                        // create the list item for the file
                        const liNode = document.createElement('li');
                        liNode.innerHTML = `
                            <div class="item_info_group">
                                <img class="icon" src="${imageUrl}" >
                                <div>
                                    <span class="file_title">${imageFile.fileName}</span>
                                    <br/>
                                    <span class="file_info">${imageFile.dataBuffer.byteLength} bytes | ${imageFile.mimeType}</span>
                                </div>
                            </div>
                        `;
                        // create the download button for downloading the image file
                        const downloadButton = document.createElement('button');
                        downloadButton.innerText = 'Download';
                        downloadButton.addEventListener('click', () => {
                            // create a temporary a element for downloading the file
                            const linkElement = document.createElement('a');
                            linkElement.href = imageUrl;
                            linkElement.download = imageFile.fileName;
                            document.body.appendChild(linkElement);
                            linkElement.click();
                            // clean up
                            document.body.removeChild(linkElement);
                        });
                        liNode.appendChild(downloadButton);
                        downloadItems.appendChild(liNode);
                    }
                    console.log(`generate time: ${generatedData['generateTime']}s`);

                    // do the code highlight
                    hljs.highlightAll();
                    // re-enable the controle and show the results
                    enableControls();
                    showResults();
                }).catch((err) => {
                    enableControls();
                    console.error(err);
                });

                return false;
            });


        </script>
    </body>
</html>